<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GeoRAW</title>
  <style>
    :root {
      --bg: #0f1624;
      --panel: #151e2e;
      --text: #e6eefc;
      --accent: #5eead4;
      --muted: #9ca3af;
      --danger: #ef4444;
      --error: #f97316;
      --warn: #fbbf24;
      --info: #38bdf8;
      --debug: #cbd5e1;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(94,234,212,0.12), transparent 25%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 32px 16px;
    }
    .shell {
      width: min(1000px, 100%);
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 30px 60px rgba(0,0,0,0.35);
    }
    h1 {
      margin: 0 0 8px 0;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    p.desc { margin: 0 0 20px 0; color: var(--muted); }
    .grid { display: grid; gap: 12px; }
    label { display: block; font-size: 14px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      outline: none;
      appearance: none;
    }
    select {
      background: rgba(17,24,39,0.9);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text);
    }
    select option {
      background: #0f1624;
      color: #e6eefc;
    }
    select:focus, input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(94,234,212,0.15);
    }
    input[type="checkbox"] { margin-right: 8px; }
    .row { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); }
    .picker { display: flex; align-items: stretch; gap: 0; position: relative; }
    .picker input { border-radius: 10px 0 0 10px; border-right: 0; }
    .picker-buttons { display: flex; position: relative; }
    .picker-buttons button {
      border-radius: 0 10px 10px 0;
      margin-left: 0;
      padding: 10px 14px;
      min-width: 110px;
      background: rgba(255,255,255,0.08);
      color: var(--text);
      box-shadow: none;
      border-left: 1px solid rgba(255,255,255,0.12);
    }
    .picker-buttons button + button { border-radius: 0 10px 10px 0; }
    .picker-buttons button:hover { border-color: var(--accent); }
    .picker-menu {
      position: absolute;
      right: 0;
      top: calc(100% + 4px);
      background: #111827;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      padding: 6px;
      display: none;
      z-index: 10;
      min-width: 160px;
    }
    .picker-menu button {
      width: 100%;
      text-align: left;
      background: transparent;
      color: var(--text);
      border-radius: 8px;
      padding: 10px 12px;
      box-shadow: none;
      border: 1px solid transparent;
    }
    .picker-menu button:hover { border-color: var(--accent); }
    select.level {
      font-weight: 600;
    }
    button {
      background: linear-gradient(135deg, #22d3ee, #5eead4);
      color: #0f1624;
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(34,211,238,0.35);
    }
    button.secondary {
      background: rgba(255,255,255,0.08);
      color: var(--text);
      box-shadow: none;
    }
    .actions { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
    .status { margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.04); border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); font-size: 14px; display:none; }
    .progress {
      margin-top: 12px;
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.08);
      border-radius: 999px;
      overflow: hidden;
      display: none;
    }
    .progress-bar {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #4ade80);
      transition: width 0.3s ease;
    }
    .progress-bar.indeterminate {
      width: 40%;
      animation: indeterminate 1.1s linear infinite;
    }
    .progress-bar.complete {
      width: 100%;
      animation: none;
    }
    @keyframes indeterminate {
      0% { margin-left: -40%; }
      50% { margin-left: 30%; width: 60%; }
      100% { margin-left: 110%; }
    }
    .hidden { display: none !important; }
    .results {
      max-height: 280px;
      overflow: auto;
      display: none;
    }
    .result-row {
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 10px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .result-info { display: flex; flex-direction: column; gap: 4px; min-width: 0; }
    .result-path { color: #e5e7eb; word-break: break-all; }
    .result-msg { color: #9ca3af; font-size: 13px; }
    .badge {
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 12px;
      white-space: nowrap;
      border: 1px solid rgba(255,255,255,0.08);
      color: #0f1624;
    }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal {
      background: #0f1624;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 16px;
      width: min(900px, 90%);
      max-height: 80vh;
      box-shadow: 0 20px 50px rgba(0,0,0,0.45);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .modal header { display: flex; justify-content: space-between; align-items: center; }
    .modal pre {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 12px;
      margin: 0;
      overflow: auto;
      max-height: 60vh;
      color: #e5e7eb;
      font-size: 13px;
      white-space: pre-wrap;
    }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }
    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: rgba(15,22,36,0.95);
      color: #e5e7eb;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      display: none;
      z-index: 200;
      font-size: 14px;
      min-width: 220px;
    }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal {
      background: #0f1624;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 16px;
      width: min(900px, 90%);
      max-height: 80vh;
      box-shadow: 0 20px 50px rgba(0,0,0,0.45);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .modal header { display: flex; justify-content: space-between; align-items: center; }
    .modal pre {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 12px;
      margin: 0;
      overflow: auto;
      max-height: 60vh;
      color: #e5e7eb;
      font-size: 13px;
      white-space: pre-wrap;
    }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }
  </style>
</head>
<body>
  <div class="shell">
    <h1>GeoRAW</h1>
    <p class="desc">Geotag RAW photos using a GPX track and write GPS to XMP sidecars.</p>

    <div class="grid">
      <div class="row">
        <div>
          <label>GPX file</label>
          <div class="picker">
            <input id="gpxPath" type="text" placeholder="/path/track.gpx">
            <div class="picker-buttons">
              <button class="secondary" onclick="pickGPX()">Browse</button>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Photos path (file / folder / glob)</label>
          <div class="picker">
            <input id="inputPath" type="text" placeholder="/photos/*.CR3 or C:\path\one.cr3;C:\path\two.cr3">
            <div class="picker-buttons">
              <button id="photoBrowseBtn" class="secondary" onclick="togglePickerMenu(event)">Browse</button>
              <div id="pickerMenu" class="picker-menu">
                <button onclick="pickFiles(); hidePickerMenu()">Select files…</button>
                <button onclick="pickFolder(); hidePickerMenu()">Select folder…</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Log level</label>
          <select id="logLevel" class="level">
            <option value="fatal" data-color="var(--danger)" style="color: var(--danger);">fatal</option>
            <option value="error" data-color="var(--error)" style="color: var(--error);">error</option>
            <option value="warning" data-color="var(--warn)" style="color: var(--warn);">warning</option>
            <option value="info" data-color="var(--info)" style="color: var(--info);" selected>info</option>
            <option value="debug" data-color="var(--debug)" style="color: var(--debug);">debug</option>
            <option value="trace" data-color="var(--muted)" style="color: var(--muted);">trace</option>
          </select>
        </div>
        <div>
          <label>Time offset (e.g. +1h30m or -00:00:30)</label>
          <input id="timeOffset" type="text" value="0s" placeholder="+1h30m or -00:00:30">
        </div>
      </div>
      <div class="row">
        <div>
          <label><input id="recursive" type="checkbox"> Scan subdirectories</label>
        </div>
        <div>
          <label><input id="autoOffset" type="checkbox" checked> Auto-detect offset</label>
        </div>
        <div>
          <label><input id="overwrite" type="checkbox"> Overwrite existing GPS</label>
        </div>
      </div>

      <div class="actions">
        <button id="runBtn" onclick="runProcess()">Run</button>
        <button id="stopBtn" class="secondary" style="display:none;" onclick="stopProcess()">Stop</button>
      </div>

      <div id="progress" class="progress"><div class="progress-bar"></div></div>
      <div id="status" class="status"></div>
      <div id="results" class="status results"></div>
      <div id="resultsActions" class="actions" style="display:none; margin-top:4px;">
        <button class="secondary" onclick="clearResults()">Clear</button>
        <button class="secondary" onclick="showLog()">View log</button>
        <button class="secondary" onclick="openFolder()">Open folder</button>
      </div>
    </div>
  </div>

  <div id="logModal" class="modal-backdrop">
    <div class="modal">
      <header>
        <h3 style="margin:0;">Log</h3>
      </header>
      <pre id="logContent">Loading...</pre>
      <div class="modal-actions">
        <button class="secondary" onclick="copyLog()">Copy</button>
        <button class="secondary" onclick="downloadLog()">Download</button>
        <button onclick="hideLog()">Close</button>
      </div>
    </div>
  </div>
  <div id="toast" class="toast"></div>

  <script src="/wails/runtime.js"></script>
  <script>
    function fitWindowToContent() {
      if (!(window.runtime && window.runtime.WindowSetSize)) return;

      const doc = document.documentElement;
      const body = document.body;

      // content dimensions
      const contentW = Math.max(
        doc.scrollWidth,
        doc.clientWidth,
        body ? body.scrollWidth : 0,
        body ? body.clientWidth : 0
      );
      const contentH = Math.max(
        doc.scrollHeight,
        doc.clientHeight,
        body ? body.scrollHeight : 0,
        body ? body.clientHeight : 0
      );

      // account for window chrome (borders/scrollbar)
      const chromeW = Math.max(0, window.outerWidth - window.innerWidth);
      const chromeH = Math.max(0, window.outerHeight - window.innerHeight);

      const minW = 900, minH = 700;
      const maxW = Math.max(minW, (window.screen?.availWidth || contentW) - 20);
      const maxH = Math.max(minH, (window.screen?.availHeight || contentH) - 60);

      const targetWidth = Math.min(Math.max(contentW + chromeW, minW), maxW);
      const targetHeight = Math.min(Math.max(contentH + chromeH, minH), maxH);

      window.runtime.WindowSetSize(targetWidth, targetHeight);
      if (window.runtime.WindowCenter) window.runtime.WindowCenter();
    }

    window.addEventListener('load', () => {
      applyLogLevelColor();
      document.addEventListener('click', (e) => {
        const menu = document.getElementById('pickerMenu');
        const btn = document.getElementById('photoBrowseBtn');
        if (!menu || !btn) return;
        if (menu.contains(e.target) || btn.contains(e.target)) return;
        hidePickerMenu();
      });
    });

    function getBackend() {
      if (window.backend) return window.backend;
      if (window.go && window.go.gui && window.go.gui.Backend) {
        window.backend = window.go.gui.Backend;
        return window.backend;
      }
      if (window.go && window.go.main && window.go.main.Backend) {
        window.backend = window.go.main.Backend;
        return window.backend;
      }
      throw new Error("Backend is not ready yet");
    }

    let isRunning = false;

    function setRunning(running) {
      isRunning = running;
      const runBtn = document.getElementById('runBtn');
      const stopBtn = document.getElementById('stopBtn');
      const progress = document.getElementById('progress');
      const bar = document.querySelector('.progress-bar');
      runBtn.disabled = running;
      stopBtn.style.display = running ? 'inline-flex' : 'none';
      if (running) {
        progress.style.display = 'block';
        bar.classList.remove('complete');
        bar.classList.add('indeterminate');
      }
    }

    async function pickGPX() {
      try {
        const result = await getBackend().PickGPX();
        if (result) document.getElementById('gpxPath').value = result;
      } catch (e) { setStatus(e.message, true); }
    }
    async function pickFolder() {
      try {
        const result = await getBackend().PickFolder();
        if (result) document.getElementById('inputPath').value = result;
      } catch (e) { setStatus(e.message, true); }
    }
    async function pickFiles() {
      try {
        const result = await getBackend().PickFiles();
        if (result && result.length) {
          document.getElementById('inputPath').value = result.join(';');
        }
      } catch (e) { setStatus(e.message, true); }
    }

    function togglePickerMenu(e) {
      e.stopPropagation();
      const menu = document.getElementById('pickerMenu');
      if (!menu) return;
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }
    function hidePickerMenu() {
      const menu = document.getElementById('pickerMenu');
      if (menu) menu.style.display = 'none';
    }

    async function runProcess() {
      setStatus("Running...", false);
      setRunning(true);
      const resultsEl = document.getElementById('results');
      resultsEl.innerHTML = "";
      resultsEl.style.display = 'none';
      document.getElementById('resultsActions').style.display = 'none';
      resetProgress(false);
      await getBackend().ClearLogs();
      lastFolderPath = "";
      const req = {
        gpxPath: document.getElementById('gpxPath').value,
        inputPath: document.getElementById('inputPath').value,
        recursive: document.getElementById('recursive').checked,
        logLevel: document.getElementById('logLevel').value,
        timeOffset: (document.getElementById('timeOffset').value || "0s").trim(),
        autoOffset: document.getElementById('autoOffset').checked,
        overwrite: document.getElementById('overwrite').checked,
      };
      try {
        const res = await getBackend().Process(req);
        renderResults(res);
      } catch (err) {
        setStatus(err.message || String(err), true);
      } finally {
        setRunning(false);
        markProgressComplete();
      }
    }

    async function stopProcess() {
      try {
        await getBackend().Cancel();
        setStatus("Cancelling...", false);
      } catch (err) {
        setStatus(err.message || String(err), true);
      }
    }

    function setStatus(msg, isError) {
      const el = document.getElementById('status');
      if (!msg) {
        el.style.display = 'none';
        return;
      }
      el.textContent = msg;
      el.style.color = isError ? "#fca5a5" : "#e6eefc";
      el.style.display = 'block';
    }

    function renderResults(summary) {
      if (!summary) return;
      const hasErrors = (summary.failed > 0) || (summary.meta_errors > 0);
      if (hasErrors) {
        const status = `Finished with issues. failed=${summary.failed} meta_errors=${summary.meta_errors}`;
        setStatus(status, true);
        showToast("Finished with issues", "warn");
      } else {
        setStatus("", false);
        showToast("Finished", "info");
      }

      let html = "";
      (summary.files || []).forEach(item => {
        const colors = {
          processed: { bg: "#34d399", fg: "#0f172a" },
          unchanged: { bg: "#a5b4fc", fg: "#0f172a" },
          skipped: { bg: "#9ca3af", fg: "#0f172a" },
          out_of_track: { bg: "#fbbf24", fg: "#0f172a" },
          meta_error: { bg: "#f97316", fg: "#0f172a" },
          failed: { bg: "#f87171", fg: "#0f172a" },
        };
        const palette = colors[item.status] || { bg: "#e5e7eb", fg: "#0f172a" };
        html += `<div class="result-row">
          <div class="result-info">
            <span class="result-path">${item.path}</span>
            ${item.message ? `<span class="result-msg">${item.message}</span>` : ""}
          </div>
          <span class="badge" style="background:${palette.bg};color:${palette.fg};">${item.status}</span>
        </div>`;
      });
      const resultsEl = document.getElementById('results');
      resultsEl.innerHTML = html || "<div style='color:#9ca3af;'>No files processed.</div>";
      resultsEl.style.display = summary.files && summary.files.length ? 'block' : 'none';
      document.getElementById('resultsActions').style.display = summary.files && summary.files.length ? 'flex' : 'none';
      if (summary.files && summary.files.length) {
        const firstPath = summary.files[0].path || "";
        lastFolderPath = extractDir(firstPath);
      }
    }

    function applyLogLevelColor() {
      const select = document.getElementById('logLevel');
      const opt = select.options[select.selectedIndex];
      const color = opt.getAttribute('data-color') || 'var(--text)';
      select.style.color = color;
    }
    document.getElementById('logLevel').addEventListener('change', applyLogLevelColor);

    function markProgressComplete() {
      const progress = document.getElementById('progress');
      const bar = document.querySelector('.progress-bar');
      progress.style.display = 'block';
      bar.classList.remove('indeterminate');
      bar.classList.add('complete');
      bar.style.marginLeft = '0';
    }

    function resetProgress(hide = true) {
      const progress = document.getElementById('progress');
      const bar = document.querySelector('.progress-bar');
      bar.classList.remove('indeterminate', 'complete');
      bar.style.marginLeft = '0';
      if (hide) progress.style.display = 'none';
    }

    function clearResults() {
      document.getElementById('results').innerHTML = "";
      document.getElementById('results').style.display = 'none';
      setStatus("", false);
      document.getElementById('resultsActions').style.display = 'none';
      resetProgress();
      cachedLog = "";
      hideLog();
      lastFolderPath = "";
    }

    document.getElementById('gpxPath').addEventListener('input', () => resetProgress());
    document.getElementById('inputPath').addEventListener('input', () => resetProgress());

    let cachedLog = "";
    let lastFolderPath = "";
    let toastTimer = null;

    function extractDir(path) {
      if (!path) return "";
      const normalized = path.replace(/\\/g, "/");
      const idx = normalized.lastIndexOf("/");
      if (idx === -1) return path;
      return normalized.slice(0, idx);
    }

    async function openFolder() {
      if (!lastFolderPath) {
        showToast("No folder to open", "warn");
        return;
      }
      try {
        await getBackend().OpenFolder(lastFolderPath);
        showToast("Opening folder");
      } catch (e) {
        showToast(e.message || "Failed to open folder", "error");
      }
    }
    async function showLog() {
      try {
        const log = await getBackend().GetLogs();
        cachedLog = log || "";
        document.getElementById('logContent').textContent = cachedLog || "Log is empty.";
        document.getElementById('logModal').style.display = 'flex';
      } catch (e) {
        setStatus(e.message, true);
      }
    }
    function hideLog() {
      document.getElementById('logModal').style.display = 'none';
    }
    async function downloadLog() {
      try {
        const path = await getBackend().SaveLog();
        if (path) {
          showToast("Log saved");
        }
      } catch (e) {
        showToast(e.message || "Failed to save log", "error");
      }
    }
    async function copyLog() {
      const data = cachedLog || document.getElementById('logContent').textContent || "";
      try {
        await navigator.clipboard.writeText(data);
        showToast("Log copied to clipboard");
      } catch (e) {
        showToast("Failed to copy log", "error");
      }
    }

    function showToast(msg, kind = "info") {
      const toast = document.getElementById('toast');
      if (!toast) return;
      toast.textContent = msg;
      const colorMap = { info: "#38bdf8", warn: "#fbbf24", error: "#f97316" };
      toast.style.borderColor = colorMap[kind] || "rgba(255,255,255,0.12)";
      toast.style.display = 'block';
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { toast.style.display = 'none'; }, 2500);
    }
  </script>
</body>
</html>
